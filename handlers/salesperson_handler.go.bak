package handlers

import (
	"fmt"
	"log"
	"math"
	"strconv"
	"time"

	"github.com/gofiber/fiber/v2"
	"gorm.io/gorm"

	"go_creation/database"
	"go_creation/models"
	"go_creation/utils"
)

// CreateSalesperson åˆ›å»ºæ–°é”€å”®å‘˜
// æ¥æ”¶é”€å”®å‘˜çš„åŸºæœ¬ä¿¡æ¯ï¼Œåˆ›å»ºæ–°çš„é”€å”®å‘˜è®°å½•å¹¶ä¿å­˜åˆ°æ•°æ®åº?func CreateSalesperson(c *fiber.Ctx) error {
	// è§£æè¯·æ±‚ä½“ä¸­çš„é”€å”®å‘˜æ•°æ®
	var requestData struct {
		models.Salesperson
		Password string `json:"password"`
	}
	
	if err := c.BodyParser(&requestData); err != nil {
		return c.Status(fiber.StatusBadRequest).JSON(fiber.Map{
			"error": "å‚æ•°è§£æå¤±è´¥: " + err.Error(),
		})
	}

	// å°†è§£æçš„æ•°æ®å¤åˆ¶åˆ°é”€å”®å‘˜å¯¹è±¡
	salesperson := requestData.Salesperson

	// éªŒè¯å¿…å¡«å­—æ®µ
	if salesperson.Username == "" {
		return c.Status(fiber.StatusBadRequest).JSON(fiber.Map{
			"error": "ç”¨æˆ·åä¸èƒ½ä¸ºç©?,
		})
	}

	if salesperson.Name == "" {
		return c.Status(fiber.StatusBadRequest).JSON(fiber.Map{
			"error": "å§“åä¸èƒ½ä¸ºç©º",
		})
	}

	// éªŒè¯ç”¨æˆ·åæ˜¯å¦å·²å­˜åœ¨
	var existingSalesperson models.Salesperson
	result := database.GetDB().Where("username = ?", salesperson.Username).First(&existingSalesperson)
	if result.Error == nil {
		return c.Status(fiber.StatusBadRequest).JSON(fiber.Map{
			"error": "ç”¨æˆ·åå·²å­˜åœ¨",
		})
	} else if result.Error != gorm.ErrRecordNotFound {
		// å¦‚æœå‘ç”Ÿå…¶ä»–é”™è¯¯ï¼Œè¿”å›æœåŠ¡å™¨é”™è¯¯
		log.Printf("æŸ¥è¯¢é”€å”®å‘˜å¤±è´¥: %v", result.Error)
		return c.Status(fiber.StatusInternalServerError).JSON(fiber.Map{
			"error": "æŸ¥è¯¢é”€å”®å‘˜å¤±è´¥",
		})
	}

	// è®¾ç½®é»˜è®¤å€?	if salesperson.Status == "" {
		salesperson.Status = "active" // é»˜è®¤çŠ¶æ€ä¸ºåœ¨èŒ
	}

	// å¤„ç†å¯†ç 
	if requestData.Password == "" {
		return c.Status(fiber.StatusBadRequest).JSON(fiber.Map{
			"error": "å¯†ç ä¸èƒ½ä¸ºç©º",
		})
	}

	// è®¾ç½®åŠ å¯†å¯†ç 
	if err := salesperson.SetPassword(requestData.Password); err != nil {
		log.Printf("å¯†ç åŠ å¯†å¤±è´¥: %v", err)
		return c.Status(fiber.StatusInternalServerError).JSON(fiber.Map{
			"error": "å¯†ç åŠ å¯†å¤±è´¥",
		})
	}

	// ä¿å­˜é”€å”®å‘˜è®°å½•
	if err := database.GetDB().Create(&salesperson).Error; err != nil {
		log.Printf("åˆ›å»ºé”€å”®å‘˜å¤±è´¥: %v", err)
		return c.Status(fiber.StatusInternalServerError).JSON(fiber.Map{
			"error": "åˆ›å»ºé”€å”®å‘˜å¤±è´¥: " + err.Error(),
		})
	}

	// è¿”å›åˆ›å»ºæˆåŠŸçš„é”€å”®å‘˜ä¿¡æ¯
	return c.Status(fiber.StatusCreated).JSON(fiber.Map{
		"message": "é”€å”®å‘˜åˆ›å»ºæˆåŠŸ",
		"data":    salesperson,
	})
}

// GetAllSalespersons è·å–æ‰€æœ‰é”€å”®å‘˜
// æ”¯æŒåˆ†é¡µå’Œç­›é€?func GetAllSalespersons(c *fiber.Ctx) error {
	// è§£ææŸ¥è¯¢å‚æ•°
	var query models.SalespersonQuery
	if err := c.QueryParser(&query); err != nil {
		return c.Status(fiber.StatusBadRequest).JSON(fiber.Map{
			"error": "æŸ¥è¯¢å‚æ•°è§£æå¤±è´¥: " + err.Error(),
		})
	}

	// è®¾ç½®é»˜è®¤åˆ†é¡µå‚æ•°
	if query.Page <= 0 {
		query.Page = 1
	}
	if query.PageSize <= 0 {
		query.PageSize = 10
	}

	// æ„å»ºæŸ¥è¯¢
	db := database.GetDB().Model(&models.Salesperson{})

	// åº”ç”¨ç­›é€‰æ¡ä»?	if query.Username != "" {
		db = db.Where("username LIKE ?", "%"+query.Username+"%")
	}
	if query.Name != "" {
		db = db.Where("name LIKE ?", "%"+query.Name+"%")
	}
	if query.Status != "" {
		db = db.Where("status = ?", query.Status)
	}
	if query.CreatorID != 0 {
		db = db.Where("creator_id = ?", query.CreatorID)
	}

	// è®¡ç®—æ€»æ•°
	var total int64
	if err := db.Count(&total).Error; err != nil {
		log.Printf("è®¡ç®—é”€å”®å‘˜æ€»æ•°å¤±è´¥: %v", err)
		return c.Status(fiber.StatusInternalServerError).JSON(fiber.Map{
			"error": "è®¡ç®—é”€å”®å‘˜æ€»æ•°å¤±è´¥",
		})
	}

	// è·å–åˆ†é¡µæ•°æ®
	var salespersons []models.Salesperson
	offset := (query.Page - 1) * query.PageSize
	if err := db.Offset(offset).Limit(query.PageSize).Find(&salespersons).Error; err != nil {
		log.Printf("è·å–é”€å”®å‘˜åˆ—è¡¨å¤±è´¥: %v", err)
		return c.Status(fiber.StatusInternalServerError).JSON(fiber.Map{
			"error": "è·å–é”€å”®å‘˜åˆ—è¡¨å¤±è´¥",
		})
	}

	// è¿”å›ç»“æœ
	return c.JSON(fiber.Map{
		"total": total,
		"page":  query.Page,
		"size":  query.PageSize,
		"data":  salespersons,
	})
}

// GetSalesperson è·å–å•ä¸ªé”€å”®å‘˜ä¿¡æ¯
func GetSalesperson(c *fiber.Ctx) error {
	// è·å–é”€å”®å‘˜ID
	id, err := strconv.Atoi(c.Params("id"))
	if err != nil {
		return c.Status(fiber.StatusBadRequest).JSON(fiber.Map{
			"error": "æ— æ•ˆçš„é”€å”®å‘˜ID",
		})
	}

	// æŸ¥è¯¢é”€å”®å‘˜
	var salesperson models.Salesperson
	if err := database.GetDB().First(&salesperson, id).Error; err != nil {
		if err == gorm.ErrRecordNotFound {
			return c.Status(fiber.StatusNotFound).JSON(fiber.Map{
				"error": "é”€å”®å‘˜ä¸å­˜åœ?,
			})
		}
		log.Printf("è·å–é”€å”®å‘˜å¤±è´¥: %v", err)
		return c.Status(fiber.StatusInternalServerError).JSON(fiber.Map{
			"error": "è·å–é”€å”®å‘˜å¤±è´¥",
		})
	}

	// è¿”å›é”€å”®å‘˜ä¿¡æ¯
	return c.JSON(fiber.Map{
		"data": salesperson,
	})
}

// UpdateSalesperson æ›´æ–°é”€å”®å‘˜ä¿¡æ¯
func UpdateSalesperson(c *fiber.Ctx) error {
	// è·å–é”€å”®å‘˜ID
	id, err := strconv.Atoi(c.Params("id"))
	if err != nil {
		return c.Status(fiber.StatusBadRequest).JSON(fiber.Map{
			"error": "æ— æ•ˆçš„é”€å”®å‘˜ID",
		})
	}

	// æŸ¥è¯¢é”€å”®å‘˜æ˜¯å¦å­˜åœ¨
	var salesperson models.Salesperson
	if err := database.GetDB().First(&salesperson, id).Error; err != nil {
		if err == gorm.ErrRecordNotFound {
			return c.Status(fiber.StatusNotFound).JSON(fiber.Map{
				"error": "é”€å”®å‘˜ä¸å­˜åœ?,
			})
		}
		log.Printf("æŸ¥è¯¢é”€å”®å‘˜å¤±è´¥: %v", err)
		return c.Status(fiber.StatusInternalServerError).JSON(fiber.Map{
			"error": "æŸ¥è¯¢é”€å”®å‘˜å¤±è´¥",
		})
	}

	// è§£æè¯·æ±‚ä½?	var updateData struct {
		Name           string  `json:"name"`
		Phone          string  `json:"phone"`
		Email          string  `json:"email"`
		Status         string  `json:"status"`
		Avatar         string  `json:"avatar"`
		CommissionRate float64 `json:"commission_rate"`
		Password       string  `json:"password"`
	}

	if err := c.BodyParser(&updateData); err != nil {
		return c.Status(fiber.StatusBadRequest).JSON(fiber.Map{
			"error": "å‚æ•°è§£æå¤±è´¥: " + err.Error(),
		})
	}

	// æ›´æ–°å­—æ®µ
	updates := make(map[string]interface{})

	if updateData.Name != "" {
		updates["name"] = updateData.Name
	}
	if updateData.Phone != "" {
		updates["phone"] = updateData.Phone
	}
	if updateData.Email != "" {
		updates["email"] = updateData.Email
	}
	if updateData.Status != "" {
		updates["status"] = updateData.Status
	}
	if updateData.Avatar != "" {
		updates["avatar"] = updateData.Avatar
	}
	if updateData.CommissionRate > 0 {
		updates["commission_rate"] = updateData.CommissionRate
	}

	// å¤„ç†å¯†ç æ›´æ–°
	if updateData.Password != "" {
		if err := salesperson.SetPassword(updateData.Password); err != nil {
			log.Printf("å¯†ç åŠ å¯†å¤±è´¥: %v", err)
			return c.Status(fiber.StatusInternalServerError).JSON(fiber.Map{
				"error": "å¯†ç åŠ å¯†å¤±è´¥",
			})
		}
		updates["password"] = salesperson.Password
	}

	// æ‰§è¡Œæ›´æ–°
	if err := database.GetDB().Model(&salesperson).Updates(updates).Error; err != nil {
		log.Printf("æ›´æ–°é”€å”®å‘˜å¤±è´¥: %v", err)
		return c.Status(fiber.StatusInternalServerError).JSON(fiber.Map{
			"error": "æ›´æ–°é”€å”®å‘˜å¤±è´¥: " + err.Error(),
		})
	}

	// é‡æ–°è·å–æ›´æ–°åçš„é”€å”®å‘˜ä¿¡æ¯
	if err := database.GetDB().First(&salesperson, id).Error; err != nil {
		log.Printf("è·å–æ›´æ–°åçš„é”€å”®å‘˜ä¿¡æ¯å¤±è´¥: %v", err)
		return c.Status(fiber.StatusInternalServerError).JSON(fiber.Map{
			"error": "è·å–æ›´æ–°åçš„é”€å”®å‘˜ä¿¡æ¯å¤±è´¥",
		})
	}

	// è¿”å›æ›´æ–°åçš„é”€å”®å‘˜ä¿¡æ¯
	return c.JSON(fiber.Map{
		"message": "é”€å”®å‘˜ä¿¡æ¯æ›´æ–°æˆåŠŸ",
		"data":    salesperson,
	})
}

// DeleteSalesperson åˆ é™¤é”€å”®å‘˜
func DeleteSalesperson(c *fiber.Ctx) error {
	// è·å–é”€å”®å‘˜ID
	id, err := strconv.Atoi(c.Params("id"))
	if err != nil {
		return c.Status(fiber.StatusBadRequest).JSON(fiber.Map{
			"error": "æ— æ•ˆçš„é”€å”®å‘˜ID",
		})
	}

	// æŸ¥è¯¢é”€å”®å‘˜æ˜¯å¦å­˜åœ¨
	var salesperson models.Salesperson
	if err := database.GetDB().First(&salesperson, id).Error; err != nil {
		if err == gorm.ErrRecordNotFound {
			return c.Status(fiber.StatusNotFound).JSON(fiber.Map{
				"error": "é”€å”®å‘˜ä¸å­˜åœ?,
			})
		}
		log.Printf("æŸ¥è¯¢é”€å”®å‘˜å¤±è´¥: %v", err)
		return c.Status(fiber.StatusInternalServerError).JSON(fiber.Map{
			"error": "æŸ¥è¯¢é”€å”®å‘˜å¤±è´¥",
		})
	}

	// æ‰§è¡Œåˆ é™¤
	if err := database.GetDB().Delete(&salesperson).Error; err != nil {
		log.Printf("åˆ é™¤é”€å”®å‘˜å¤±è´¥: %v", err)
		return c.Status(fiber.StatusInternalServerError).JSON(fiber.Map{
			"error": "åˆ é™¤é”€å”®å‘˜å¤±è´¥: " + err.Error(),
		})
	}

	// è¿”å›æˆåŠŸæ¶ˆæ¯
	return c.JSON(fiber.Map{
		"message": "é”€å”®å‘˜åˆ é™¤æˆåŠŸ",
	})
}

// å¤„ç†ç™»å½•å¤±è´¥å“åº”
func handleLoginFailure(c *fiber.Ctx, username string, message string) error {
	// è®°å½•å¤±è´¥çš„ç™»å½•å°è¯?	isLocked, minutes := utils.DefaultLoginLimiter.RecordFailedLogin(username)

	log.Printf("ç™»å½•å¤±è´¥ï¼?s: %s", message, username)

	var response fiber.Map
	if isLocked {
		response = fiber.Map{
			"error":   "ç™»å½•å°è¯•æ¬¡æ•°è¿‡å¤šï¼Œè´¦å·å·²è¢«ä¸´æ—¶é”å®?,
			"minutes": minutes,
		}
	} else {
		remainingAttempts := utils.DefaultLoginLimiter.GetRemainingAttempts(username)
		response = fiber.Map{
			"error":              "ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯",
			"remaining_attempts": remainingAttempts,
		}
	}

	return c.Status(fiber.StatusUnauthorized).JSON(response)
}

// SalespersonLogin é”€å”®å‘˜ç™»å½•
func SalespersonLogin(c *fiber.Ctx) error {
	// è§£æè¯·æ±‚æ•°æ®
	var loginData struct {
		Username string `json:"username"`
		Password string `json:"password"`
	}

	if err := c.BodyParser(&loginData); err != nil {
		log.Printf("è§£æç™»å½•æ•°æ®å¤±è´¥: %v", err)
		return c.Status(fiber.StatusBadRequest).JSON(fiber.Map{
			"error": "å‚æ•°è§£æå¤±è´¥ï¼Œè¯·æ£€æŸ¥è¾“å…¥æ ¼å¼?,
		})
	}

	// éªŒè¯å¿…å¡«å­—æ®µ
	if loginData.Username == "" || loginData.Password == "" {
		return c.Status(fiber.StatusBadRequest).JSON(fiber.Map{
			"error": "ç”¨æˆ·åå’Œå¯†ç ä¸èƒ½ä¸ºç©º",
		})
	}

	// æ£€æŸ¥ç™»å½•å°è¯•æ¬¡æ•°é™åˆ?	isLocked, remainingMinutes := utils.DefaultLoginLimiter.IsLocked(loginData.Username)
	if isLocked {
		return c.Status(fiber.StatusTooManyRequests).JSON(fiber.Map{
			"error":   "ç™»å½•å°è¯•æ¬¡æ•°è¿‡å¤šï¼Œè´¦å·å·²è¢«ä¸´æ—¶é”å®?,
			"minutes": remainingMinutes,
		})
	}

	// æŸ¥è¯¢é”€å”®å‘˜ä¿¡æ¯
	var salesperson models.Salesperson
	if err := database.GetDB().Where("username = ?", loginData.Username).First(&salesperson).Error; err != nil {
		// ä¸è¦æ³„éœ²ç”¨æˆ·æ˜¯å¦å­˜åœ¨çš„ä¿¡æ¯ï¼Œç»Ÿä¸€è¿”å›ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯
		return handleLoginFailure(c, loginData.Username, "ç”¨æˆ·åä¸å­˜åœ¨")
	}

	// éªŒè¯å¯†ç 
	if !salesperson.CheckPassword(loginData.Password) {
		return handleLoginFailure(c, loginData.Username, "å¯†ç é”™è¯¯")
	}

	// æ£€æŸ¥é”€å”®å‘˜çŠ¶æ€?	if salesperson.Status != "active" {
		log.Printf("ç™»å½•å¤±è´¥ï¼Œè´¦å·çŠ¶æ€éæ´»è·ƒ: %s, çŠ¶æ€? %s", loginData.Username, salesperson.Status)
		return c.Status(fiber.StatusForbidden).JSON(fiber.Map{
			"error": "è´¦å·å·²è¢«ç¦ç”¨ï¼Œè¯·è”ç³»ç®¡ç†å‘?,
		})
	}

	// é‡ç½®ç™»å½•å°è¯•æ¬¡æ•°
	utils.DefaultLoginLimiter.ResetAttempts(loginData.Username)

	// æ‡’æƒ°åˆ é™¤ï¼šæ¸…ç†è¯¥ç”¨æˆ·çš„è¿‡æœŸä»¤ç‰?	if err := database.GetDB().Where("salesperson_id = ? AND expired_at < ?", salesperson.ID, time.Now()).Delete(&models.SalespersonToken{}).Error; err != nil {
		log.Printf("åˆ é™¤è¿‡æœŸä»¤ç‰Œå¤±è´¥: %v", err)
		// ä¸è¿”å›é”™è¯¯ï¼Œç»§ç»­å¤„ç†
	}

	// ç”ŸæˆJWTä»¤ç‰Œï¼Œæœ‰æ•ˆæœŸ24å°æ—¶
	token, err := utils.GenerateToken(salesperson.ID, salesperson.Username, 24*time.Hour)
	if err != nil {
		log.Printf("ç”Ÿæˆä»¤ç‰Œå¤±è´¥: %v", err)
		return c.Status(fiber.StatusInternalServerError).JSON(fiber.Map{
			"error": "ç™»å½•å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•",
		})
	}

	// è·å–å®¢æˆ·ç«¯ä¿¡æ?	userAgent := c.Get("User-Agent")
	ip := c.IP()

	// å®šä¹‰è¿‡æœŸæ—¶é—´
	expireTime := time.Now().Add(24 * time.Hour)

	// å­˜å‚¨ä»¤ç‰Œåˆ°æ•°æ®åº“
	salespersonToken := models.SalespersonToken{
		SalespersonID: salesperson.ID,
		Token:         token,
		UserAgent:     userAgent,
		IP:            ip,
		ExpiredAt:     expireTime,
	}

	if err := database.GetDB().Create(&salespersonToken).Error; err != nil {
		log.Printf("å­˜å‚¨ä»¤ç‰Œå¤±è´¥: %v", err)
		return c.Status(fiber.StatusInternalServerError).JSON(fiber.Map{
			"error": "ç™»å½•å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•",
		})
	}

	// æ›´æ–°æœ€åç™»å½•æ—¶é—?	now := time.Now()
	salesperson.LastLoginAt = &now
	if err := database.GetDB().Model(&salesperson).Update("last_login_at", now).Error; err != nil {
		log.Printf("æ›´æ–°æœ€åç™»å½•æ—¶é—´å¤±è´? %v", err)
	}

	log.Printf("ç”¨æˆ·ç™»å½•æˆåŠŸ: %s, ID: %d", salesperson.Username, salesperson.ID)

	// è¿”å›ç™»å½•æˆåŠŸä¿¡æ¯å’Œä»¤ç‰?	return c.JSON(fiber.Map{
		"message":    "ç™»å½•æˆåŠŸ",
		"token":      token,
		"expires_at": expireTime.Unix(), // è¿”å›è¿‡æœŸæ—¶é—´æˆ³ï¼Œæ–¹ä¾¿å‰ç«¯å¤„ç†
		"data": fiber.Map{
			"id":       salesperson.ID,
			"username": salesperson.Username,
			"name":     salesperson.Name,
			"status":   salesperson.Status,
			"avatar":   salesperson.Avatar,
		},
	})
}

// AssignProductToSalesperson ä¸ºé”€å”®å‘˜åˆ†é…äº§å“
func AssignProductToSalesperson(c *fiber.Ctx) error {
	// è§£æè¯·æ±‚æ•°æ®
	var assignData struct {
		SalespersonID  uint    `json:"salesperson_id"`
		SoftwareID     uint    `json:"software_id"`
		KeyTypeID      uint    `json:"key_type_id"`
		CommissionRate float64 `json:"commission_rate"`
		KeyGenLimit    int     `json:"key_gen_limit"`
	}

	if err := c.BodyParser(&assignData); err != nil {
		return c.Status(fiber.StatusBadRequest).JSON(fiber.Map{
			"error": "å‚æ•°è§£æå¤±è´¥: " + err.Error(),
		})
	}

	// éªŒè¯å¿…å¡«å­—æ®µ
	if assignData.SalespersonID == 0 || assignData.SoftwareID == 0 || assignData.KeyTypeID == 0 {
		return c.Status(fiber.StatusBadRequest).JSON(fiber.Map{
			"error": "é”€å”®å‘˜IDã€è½¯ä»¶IDå’Œå¡å¯†ç±»å‹IDä¸èƒ½ä¸ºç©º",
		})
	}

	// éªŒè¯é”€å”®å‘˜æ˜¯å¦å­˜åœ¨
	var salesperson models.Salesperson
	if err := database.GetDB().First(&salesperson, assignData.SalespersonID).Error; err != nil {
		if err == gorm.ErrRecordNotFound {
			return c.Status(fiber.StatusNotFound).JSON(fiber.Map{
				"error": "é”€å”®å‘˜ä¸å­˜åœ?,
			})
		}
		log.Printf("æŸ¥è¯¢é”€å”®å‘˜å¤±è´¥: %v", err)
		return c.Status(fiber.StatusInternalServerError).JSON(fiber.Map{
			"error": "æŸ¥è¯¢é”€å”®å‘˜å¤±è´¥",
		})
	}

	// éªŒè¯è½¯ä»¶æ˜¯å¦å­˜åœ¨
	var software models.Software
	if err := database.GetDB().First(&software, assignData.SoftwareID).Error; err != nil {
		if err == gorm.ErrRecordNotFound {
			return c.Status(fiber.StatusNotFound).JSON(fiber.Map{
				"error": "è½¯ä»¶ä¸å­˜åœ?,
			})
		}
		log.Printf("æŸ¥è¯¢è½¯ä»¶å¤±è´¥: %v", err)
		return c.Status(fiber.StatusInternalServerError).JSON(fiber.Map{
			"error": "æŸ¥è¯¢è½¯ä»¶å¤±è´¥",
		})
	}

	// éªŒè¯å¡å¯†ç±»å‹æ˜¯å¦å­˜åœ¨
	var keyType models.KeyType
	if err := database.GetDB().First(&keyType, assignData.KeyTypeID).Error; err != nil {
		if err == gorm.ErrRecordNotFound {
			return c.Status(fiber.StatusNotFound).JSON(fiber.Map{
				"error": "å¡å¯†ç±»å‹ä¸å­˜åœ?,
			})
		}
		log.Printf("æŸ¥è¯¢å¡å¯†ç±»å‹å¤±è´¥: %v", err)
		return c.Status(fiber.StatusInternalServerError).JSON(fiber.Map{
			"error": "æŸ¥è¯¢å¡å¯†ç±»å‹å¤±è´¥",
		})
	}

	// éªŒè¯è½¯ä»¶å’Œå¡å¯†ç±»å‹æ˜¯å¦å·²ç»‘å®š
	var softwareKeyType models.SoftwareKeyType
	if err := database.GetDB().Where("software_id = ? AND key_type_id = ?", assignData.SoftwareID, assignData.KeyTypeID).First(&softwareKeyType).Error; err != nil {
		if err == gorm.ErrRecordNotFound {
			return c.Status(fiber.StatusBadRequest).JSON(fiber.Map{
				"error": "è½¯ä»¶å’Œå¡å¯†ç±»å‹æœªç»‘å®šï¼Œè¯·å…ˆç»‘å®?,
			})
		}
		log.Printf("æŸ¥è¯¢è½¯ä»¶å’Œå¡å¯†ç±»å‹ç»‘å®šå…³ç³»å¤±è´? %v", err)
		return c.Status(fiber.StatusInternalServerError).JSON(fiber.Map{
			"error": "æŸ¥è¯¢è½¯ä»¶å’Œå¡å¯†ç±»å‹ç»‘å®šå…³ç³»å¤±è´?,
		})
	}

	// æ£€æŸ¥æ˜¯å¦å·²åˆ†é…
	var existingAssignment models.SalespersonProduct
	result := database.GetDB().Where("salesperson_id = ? AND software_id = ? AND key_type_id = ?",
		assignData.SalespersonID, assignData.SoftwareID, assignData.KeyTypeID).First(&existingAssignment)

	if result.Error == nil {
		// å·²å­˜åœ¨ï¼Œæ›´æ–°
		updates := map[string]interface{}{
			"is_active": true,
		}

		if assignData.CommissionRate > 0 {
			updates["commission_rate"] = assignData.CommissionRate
		}

		if assignData.KeyGenLimit > 0 {
			updates["key_gen_limit"] = assignData.KeyGenLimit
		}

		if err := database.GetDB().Model(&existingAssignment).Updates(updates).Error; err != nil {
			log.Printf("æ›´æ–°äº§å“åˆ†é…å¤±è´¥: %v", err)
			return c.Status(fiber.StatusInternalServerError).JSON(fiber.Map{
				"error": "æ›´æ–°äº§å“åˆ†é…å¤±è´¥: " + err.Error(),
			})
		}

		return c.JSON(fiber.Map{
			"message": "äº§å“åˆ†é…æ›´æ–°æˆåŠŸ",
			"data":    existingAssignment,
		})
	} else if result.Error != gorm.ErrRecordNotFound {
		log.Printf("æŸ¥è¯¢äº§å“åˆ†é…å¤±è´¥: %v", result.Error)
		return c.Status(fiber.StatusInternalServerError).JSON(fiber.Map{
			"error": "æŸ¥è¯¢äº§å“åˆ†é…å¤±è´¥",
		})
	}

	// åˆ›å»ºæ–°çš„åˆ†é…
	salespersonProduct := models.SalespersonProduct{
		SalespersonID:  assignData.SalespersonID,
		SoftwareID:     assignData.SoftwareID,
		KeyTypeID:      assignData.KeyTypeID,
		CommissionRate: assignData.CommissionRate,
		KeyGenLimit:    assignData.KeyGenLimit,
		IsActive:       true,
	}

	if err := database.GetDB().Create(&salespersonProduct).Error; err != nil {
		log.Printf("åˆ›å»ºäº§å“åˆ†é…å¤±è´¥: %v", err)
		return c.Status(fiber.StatusInternalServerError).JSON(fiber.Map{
			"error": "åˆ›å»ºäº§å“åˆ†é…å¤±è´¥: " + err.Error(),
		})
	}

	return c.Status(fiber.StatusCreated).JSON(fiber.Map{
		"message": "äº§å“åˆ†é…æˆåŠŸ",
		"data":    salespersonProduct,
	})
}

// GetSalespersonProducts è·å–é”€å”®å‘˜å¯é”€å”®çš„äº§å“åˆ—è¡¨
func GetSalespersonProducts(c *fiber.Ctx) error {
	// è·å–é”€å”®å‘˜ID
	id, err := strconv.Atoi(c.Params("id"))
	if err != nil {
		return c.Status(fiber.StatusBadRequest).JSON(fiber.Map{
			"error": "æ— æ•ˆçš„é”€å”®å‘˜ID",
		})
	}

	// æŸ¥è¯¢é”€å”®å‘˜æ˜¯å¦å­˜åœ¨
	var salesperson models.Salesperson
	if err := database.GetDB().First(&salesperson, id).Error; err != nil {
		if err == gorm.ErrRecordNotFound {
			return c.Status(fiber.StatusNotFound).JSON(fiber.Map{
				"error": "é”€å”®å‘˜ä¸å­˜åœ?,
			})
		}
		log.Printf("æŸ¥è¯¢é”€å”®å‘˜å¤±è´¥: %v", err)
		return c.Status(fiber.StatusInternalServerError).JSON(fiber.Map{
			"error": "æŸ¥è¯¢é”€å”®å‘˜å¤±è´¥",
		})
	}

	// æŸ¥è¯¢é”€å”®å‘˜å¯é”€å”®çš„äº§å“
	var products []struct {
		models.SalespersonProduct
		SoftwareName string  `json:"software_name"`
		KeyTypeName  string  `json:"key_type_name"`
		Hours        int     `json:"hours"`
		Price        float64 `json:"price"`
	}

	query := `
		SELECT sp.*, s.name as software_name, kt.name as key_type_name, kt.hours, kt.price
		FROM salesperson_products sp
		JOIN softwares s ON sp.software_id = s.id
		JOIN key_types kt ON sp.key_type_id = kt.id
		WHERE sp.salesperson_id = ? AND sp.is_active = true
	`

	if err := database.GetDB().Raw(query, id).Scan(&products).Error; err != nil {
		log.Printf("æŸ¥è¯¢é”€å”®å‘˜äº§å“å¤±è´¥: %v", err)
		return c.Status(fiber.StatusInternalServerError).JSON(fiber.Map{
			"error": "æŸ¥è¯¢é”€å”®å‘˜äº§å“å¤±è´¥",
		})
	}

	return c.JSON(fiber.Map{
		"data": products,
	})
}

// GenerateKeysForSalesperson é”€å”®å‘˜ç”Ÿæˆå¡å¯†
func GenerateKeysForSalesperson(c *fiber.Ctx) error {
	// ä»ä¸Šä¸‹æ–‡ä¸­è·å–é”€å”®å‘˜ID
	salespersonID, ok := c.Locals("salesperson_id").(uint)
	if !ok {
		return c.Status(fiber.StatusUnauthorized).JSON(fiber.Map{
			"error": "æœªæ‰¾åˆ°é”€å”®å‘˜èº«ä»½ä¿¡æ¯",
		})
	}

	// è§£æè¯·æ±‚æ•°æ®
	var genData struct {
		SoftwareID    uint   `json:"software_id"`
		KeyTypeID     uint   `json:"key_type_id"`
		Count         int    `json:"count"`
		CustomerName  string `json:"customer_name"`
		CustomerPhone string `json:"customer_phone"`
		CustomerEmail string `json:"customer_email"`
		Notes         string `json:"notes"`
	}

	if err := c.BodyParser(&genData); err != nil {
		return c.Status(fiber.StatusBadRequest).JSON(fiber.Map{
			"error": "å‚æ•°è§£æå¤±è´¥: " + err.Error(),
		})
	}

	// éªŒè¯å¿…å¡«å­—æ®µ
	if genData.SoftwareID == 0 || genData.KeyTypeID == 0 || genData.Count <= 0 {
		return c.Status(fiber.StatusBadRequest).JSON(fiber.Map{
			"error": "è½¯ä»¶IDã€å¡å¯†ç±»å‹IDå’Œæ•°é‡ä¸èƒ½ä¸ºç©?,
		})
	}

	// éªŒè¯é”€å”®å‘˜æ˜¯å¦å­˜åœ¨
	var salesperson models.Salesperson
	if err := database.GetDB().First(&salesperson, salespersonID).Error; err != nil {
		if err == gorm.ErrRecordNotFound {
			return c.Status(fiber.StatusNotFound).JSON(fiber.Map{
				"error": "é”€å”®å‘˜ä¸å­˜åœ?,
			})
		}
		log.Printf("æŸ¥è¯¢é”€å”®å‘˜å¤±è´¥: %v", err)
		return c.Status(fiber.StatusInternalServerError).JSON(fiber.Map{
			"error": "æŸ¥è¯¢é”€å”®å‘˜å¤±è´¥",
		})
	}

	// éªŒè¯è½¯ä»¶æ˜¯å¦å­˜åœ¨
	var software models.Software
	if err := database.GetDB().First(&software, genData.SoftwareID).Error; err != nil {
		if err == gorm.ErrRecordNotFound {
			return c.Status(fiber.StatusNotFound).JSON(fiber.Map{
				"error": "è½¯ä»¶ä¸å­˜åœ?,
			})
		}
		log.Printf("æŸ¥è¯¢è½¯ä»¶å¤±è´¥: %v", err)
		return c.Status(fiber.StatusInternalServerError).JSON(fiber.Map{
			"error": "æŸ¥è¯¢è½¯ä»¶å¤±è´¥",
		})
	}

	// éªŒè¯å¡å¯†ç±»å‹æ˜¯å¦å­˜åœ¨
	var keyType models.KeyType
	if err := database.GetDB().First(&keyType, genData.KeyTypeID).Error; err != nil {
		if err == gorm.ErrRecordNotFound {
			return c.Status(fiber.StatusNotFound).JSON(fiber.Map{
				"error": "å¡å¯†ç±»å‹ä¸å­˜åœ?,
			})
		}
		log.Printf("æŸ¥è¯¢å¡å¯†ç±»å‹å¤±è´¥: %v", err)
		return c.Status(fiber.StatusInternalServerError).JSON(fiber.Map{
			"error": "æŸ¥è¯¢å¡å¯†ç±»å‹å¤±è´¥",
		})
	}

	// éªŒè¯è½¯ä»¶å’Œå¡å¯†ç±»å‹æ˜¯å¦å·²ç»‘å®š
	var softwareKeyType models.SoftwareKeyType
	if err := database.GetDB().Where("software_id = ? AND key_type_id = ?", genData.SoftwareID, genData.KeyTypeID).First(&softwareKeyType).Error; err != nil {
		if err == gorm.ErrRecordNotFound {
			return c.Status(fiber.StatusBadRequest).JSON(fiber.Map{
				"error": "è½¯ä»¶å’Œå¡å¯†ç±»å‹æœªç»‘å®šï¼Œè¯·å…ˆç»‘å®?,
			})
		}
		log.Printf("æŸ¥è¯¢è½¯ä»¶å’Œå¡å¯†ç±»å‹ç»‘å®šå…³ç³»å¤±è´? %v", err)
		return c.Status(fiber.StatusInternalServerError).JSON(fiber.Map{
			"error": "æŸ¥è¯¢è½¯ä»¶å’Œå¡å¯†ç±»å‹ç»‘å®šå…³ç³»å¤±è´?,
		})
	}

	// æ£€æŸ¥ç”Ÿæˆæ•°é‡é™åˆ?	var salespersonProduct models.SalespersonProduct
	if err := database.GetDB().Where("salesperson_id = ? AND software_id = ? AND key_type_id = ? AND is_active = true",
		salespersonID, genData.SoftwareID, genData.KeyTypeID).First(&salespersonProduct).Error; err != nil {
		if err == gorm.ErrRecordNotFound {
			return c.Status(fiber.StatusForbidden).JSON(fiber.Map{
				"error": "é”€å”®å‘˜æ— æƒç”Ÿæˆè¯¥äº§å“çš„å¡å¯†",
			})
		}
		log.Printf("æŸ¥è¯¢é”€å”®å‘˜äº§å“æƒé™å¤±è´¥: %v", err)
		return c.Status(fiber.StatusInternalServerError).JSON(fiber.Map{
			"error": "æŸ¥è¯¢é”€å”®å‘˜äº§å“æƒé™å¤±è´¥",
		})
	}

	// æ£€æŸ¥ç”Ÿæˆæ•°é‡é™åˆ?	if salespersonProduct.KeyGenLimit > 0 {
		if salespersonProduct.KeysGenerated+genData.Count > salespersonProduct.KeyGenLimit {
			return c.Status(fiber.StatusForbidden).JSON(fiber.Map{
				"error": fmt.Sprintf("è¶…å‡ºå¡å¯†ç”Ÿæˆé™åˆ¶ï¼Œå½“å‰å·²ç”Ÿæˆ %d ä¸ªï¼Œé™åˆ¶ %d ä¸?,
					salespersonProduct.KeysGenerated, salespersonProduct.KeyGenLimit),
			})
		}
	}

	// å¼€å§‹äº‹åŠ?	tx := database.GetDB().Begin()
	if tx.Error != nil {
		log.Printf("å¼€å§‹äº‹åŠ¡å¤±è´? %v", tx.Error)
		return c.Status(fiber.StatusInternalServerError).JSON(fiber.Map{
			"error": "å¼€å§‹äº‹åŠ¡å¤±è´?,
		})
	}

	// ç”Ÿæˆå¡å¯†
	keys := make([]models.Key, 0, genData.Count)
	for i := 0; i < genData.Count; i++ {
		// ç”Ÿæˆå¡å¯†ç å’Œæ¿€æ´»ç 
		keyCode := utils.GenerateSalespersonKeyCode()
		code := utils.GenerateSalespersonCode()

		// åˆ›å»ºå¡å¯†
		key := models.Key{
			Code:         code,
			KeyCode:      keyCode,
			TypeID:       genData.KeyTypeID,
			TypeName:     keyType.Name,
			Hours:        keyType.Hours,
			Price:        keyType.Price,
			Status:       "unused",
			CreatorID:    salespersonID,
			SoftwareID:   genData.SoftwareID,
			SoftwareName: software.Name,
		}

		if err := tx.Create(&key).Error; err != nil {
			tx.Rollback()
			log.Printf("åˆ›å»ºå¡å¯†å¤±è´¥: %v", err)
			return c.Status(fiber.StatusInternalServerError).JSON(fiber.Map{
				"error": "åˆ›å»ºå¡å¯†å¤±è´¥: " + err.Error(),
			})
		}

		keys = append(keys, key)
	}

	// æ›´æ–°é”€å”®å‘˜äº§å“çš„å·²ç”Ÿæˆå¡å¯†æ•°é‡
	if err := tx.Model(&models.SalespersonProduct{}).Where("id = ?", salespersonProduct.ID).
		UpdateColumn("keys_generated", gorm.Expr("keys_generated + ?", genData.Count)).Error; err != nil {
		tx.Rollback()
		log.Printf("æ›´æ–°é”€å”®å‘˜äº§å“å·²ç”Ÿæˆå¡å¯†æ•°é‡å¤±è´? %v", err)
		return c.Status(fiber.StatusInternalServerError).JSON(fiber.Map{
			"error": "æ›´æ–°é”€å”®å‘˜äº§å“å·²ç”Ÿæˆå¡å¯†æ•°é‡å¤±è´?,
		})
	}

	// åˆ›å»ºé”€å”®è®°å½?	totalAmount := float64(genData.Count) * keyType.Price
	commission := totalAmount * salespersonProduct.CommissionRate

	sale := models.SalespersonSale{
		SalespersonID:  salespersonID,
		KeyID:          0, // æ‰¹é‡ç”Ÿæˆæ—¶ä¸å…³è”å…·ä½“å¡å¯†
		SoftwareID:     genData.SoftwareID,
		KeyTypeID:      genData.KeyTypeID,
		CustomerName:   genData.CustomerName,
		CustomerPhone:  genData.CustomerPhone,
		CustomerEmail:  genData.CustomerEmail,
		SaleAmount:     totalAmount,
		CommissionRate: salespersonProduct.CommissionRate,
		Commission:     commission,
		Status:         "pending",
		Notes:          genData.Notes,
	}

	if err := tx.Create(&sale).Error; err != nil {
		tx.Rollback()
		log.Printf("åˆ›å»ºé”€å”®è®°å½•å¤±è´? %v", err)
		return c.Status(fiber.StatusInternalServerError).JSON(fiber.Map{
			"error": "åˆ›å»ºé”€å”®è®°å½•å¤±è´? " + err.Error(),
		})
	}

	// æ›´æ–°é”€å”®å‘˜çš„æ€»é”€å”®é¢å’Œæ€»ä½£é‡?	if err := tx.Model(&models.Salesperson{}).Where("id = ?", salespersonID).
		UpdateColumns(map[string]interface{}{
			"total_sales":      gorm.Expr("total_sales + ?", totalAmount),
			"total_commission": gorm.Expr("total_commission + ?", commission),
		}).Error; err != nil {
		tx.Rollback()
		log.Printf("æ›´æ–°é”€å”®å‘˜é”€å”®ç»Ÿè®¡å¤±è´? %v", err)
		return c.Status(fiber.StatusInternalServerError).JSON(fiber.Map{
			"error": "æ›´æ–°é”€å”®å‘˜é”€å”®ç»Ÿè®¡å¤±è´?,
		})
	}

	// æäº¤äº‹åŠ¡
	if err := tx.Commit().Error; err != nil {
		log.Printf("æäº¤äº‹åŠ¡å¤±è´¥: %v", err)
		return c.Status(fiber.StatusInternalServerError).JSON(fiber.Map{
			"error": "æäº¤äº‹åŠ¡å¤±è´¥",
		})
	}

	// è¿”å›ç”Ÿæˆçš„å¡å¯?	return c.Status(fiber.StatusCreated).JSON(fiber.Map{
		"message": "å¡å¯†ç”ŸæˆæˆåŠŸ",
		"data": fiber.Map{
			"keys":       keys,
			"sale":       sale,
			"total":      genData.Count,
			"amount":     totalAmount,
			"commission": commission,
		},
	})
}

// GetSalespersonSales è·å–é”€å”®å‘˜çš„é”€å”®è®°å½?func GetSalespersonSales(c *fiber.Ctx) error {
	// è·å–é”€å”®å‘˜ID
	id, err := strconv.Atoi(c.Params("id"))
	if err != nil {
		return c.Status(fiber.StatusBadRequest).JSON(fiber.Map{
			"error": "æ— æ•ˆçš„é”€å”®å‘˜ID",
		})
	}

	// è§£ææŸ¥è¯¢å‚æ•°
	var query struct {
		Status    string `query:"status"`
		StartDate string `query:"start_date"`
		EndDate   string `query:"end_date"`
		Page      int    `query:"page"`
		PageSize  int    `query:"page_size"`
	}

	if err := c.QueryParser(&query); err != nil {
		return c.Status(fiber.StatusBadRequest).JSON(fiber.Map{
			"error": "æŸ¥è¯¢å‚æ•°è§£æå¤±è´¥: " + err.Error(),
		})
	}

	// è®¾ç½®é»˜è®¤åˆ†é¡µå‚æ•°
	if query.Page <= 0 {
		query.Page = 1
	}
	if query.PageSize <= 0 {
		query.PageSize = 10
	}

	// æ„å»ºæŸ¥è¯¢
	db := database.GetDB().Model(&models.SalespersonSale{}).Where("salesperson_id = ?", id)

	// æŒ‰çŠ¶æ€ç­›é€?	if query.Status != "" {
		db = db.Where("status = ?", query.Status)
	}

	// æŒ‰æ—¶é—´èŒƒå›´ç­›é€?	if query.StartDate != "" {
		db = db.Where("created_at >= ?", query.StartDate)
	}
	if query.EndDate != "" {
		db = db.Where("created_at <= ?", query.EndDate)
	}

	// è®¡ç®—æ€»è®°å½•æ•°
	var total int64
	if err := db.Count(&total).Error; err != nil {
		log.Printf("è®¡ç®—é”€å”®è®°å½•æ€»æ•°å¤±è´¥: %v", err)
		return c.Status(fiber.StatusInternalServerError).JSON(fiber.Map{
			"error": "è®¡ç®—é”€å”®è®°å½•æ€»æ•°å¤±è´¥",
		})
	}

	// æŸ¥è¯¢é”€å”®è®°å½?	var sales []models.SalespersonSale
	offset := (query.Page - 1) * query.PageSize
	if err := db.Limit(query.PageSize).Offset(offset).Order("created_at DESC").Find(&sales).Error; err != nil {
		log.Printf("è·å–é”€å”®è®°å½•å¤±è´? %v", err)
		return c.Status(fiber.StatusInternalServerError).JSON(fiber.Map{
			"error": "è·å–é”€å”®è®°å½•å¤±è´?,
		})
	}

	// è¿”å›é”€å”®è®°å½?	return c.JSON(fiber.Map{
		"total": total,
		"page":  query.Page,
		"size":  query.PageSize,
		"data":  sales,
	})
}

// GetSalespersonCommission è·å–é”€å”®å‘˜çš„ä½£é‡‘ç»Ÿè®?func GetSalespersonCommission(c *fiber.Ctx) error {
	// è·å–é”€å”®å‘˜ID
	id, err := strconv.Atoi(c.Params("id"))
	if err != nil {
		return c.Status(fiber.StatusBadRequest).JSON(fiber.Map{
			"error": "æ— æ•ˆçš„é”€å”®å‘˜ID",
		})
	}

	// è§£ææŸ¥è¯¢å‚æ•°
	var query struct {
		StartDate string `query:"start_date"`
		EndDate   string `query:"end_date"`
	}

	if err := c.QueryParser(&query); err != nil {
		return c.Status(fiber.StatusBadRequest).JSON(fiber.Map{
			"error": "æŸ¥è¯¢å‚æ•°è§£æå¤±è´¥: " + err.Error(),
		})
	}

	// æ„å»ºæŸ¥è¯¢
	db := database.GetDB().Model(&models.SalespersonSale{}).Where("salesperson_id = ?", id)

	// æŒ‰æ—¶é—´èŒƒå›´ç­›é€?	if query.StartDate != "" {
		db = db.Where("created_at >= ?", query.StartDate)
	}

	if query.EndDate != "" {
		db = db.Where("created_at <= ?", query.EndDate)
	}

	// è®¡ç®—æ€»é”€å”®é¢å’Œæ€»ä½£é‡?	type CommissionStats struct {
		TotalSales      float64 `json:"total_sales"`
		TotalCommission float64 `json:"total_commission"`
		PendingAmount   float64 `json:"pending_amount"`
		SettledAmount   float64 `json:"settled_amount"`
		CancelledAmount float64 `json:"cancelled_amount"`
	}

	var stats CommissionStats

	// è®¡ç®—æ€»é”€å”®é¢å’Œæ€»ä½£é‡?	if err := db.Select("SUM(sale_amount) as total_sales, SUM(commission) as total_commission").Scan(&stats).Error; err != nil {
		log.Printf("è®¡ç®—ä½£é‡‘ç»Ÿè®¡å¤±è´¥: %v", err)
		return c.Status(fiber.StatusInternalServerError).JSON(fiber.Map{
			"error": "è®¡ç®—ä½£é‡‘ç»Ÿè®¡å¤±è´¥",
		})
	}

	// è®¡ç®—å¾…ç»“ç®—é‡‘é¢?	if err := db.Where("status = ?", "pending").Select("SUM(commission) as pending_amount").Scan(&stats).Error; err != nil {
		log.Printf("è®¡ç®—å¾…ç»“ç®—é‡‘é¢å¤±è´? %v", err)
		return c.Status(fiber.StatusInternalServerError).JSON(fiber.Map{
			"error": "è®¡ç®—å¾…ç»“ç®—é‡‘é¢å¤±è´?,
		})
	}

	// è®¡ç®—å·²ç»“ç®—é‡‘é¢?	if err := db.Where("status = ?", "settled").Select("SUM(commission) as settled_amount").Scan(&stats).Error; err != nil {
		log.Printf("è®¡ç®—å·²ç»“ç®—é‡‘é¢å¤±è´? %v", err)
		return c.Status(fiber.StatusInternalServerError).JSON(fiber.Map{
			"error": "è®¡ç®—å·²ç»“ç®—é‡‘é¢å¤±è´?,
		})
	}

	// è®¡ç®—å·²å–æ¶ˆé‡‘é¢?	if err := db.Where("status = ?", "cancelled").Select("SUM(commission) as cancelled_amount").Scan(&stats).Error; err != nil {
		log.Printf("è®¡ç®—å·²å–æ¶ˆé‡‘é¢å¤±è´? %v", err)
		return c.Status(fiber.StatusInternalServerError).JSON(fiber.Map{
			"error": "è®¡ç®—å·²å–æ¶ˆé‡‘é¢å¤±è´?,
		})
	}

	// è·å–é”€å”®å‘˜ä¿¡æ¯
	var salesperson models.Salesperson
	if err := database.GetDB().First(&salesperson, id).Error; err != nil {
		log.Printf("è·å–é”€å”®å‘˜ä¿¡æ¯å¤±è´¥: %v", err)
		return c.Status(fiber.StatusInternalServerError).JSON(fiber.Map{
			"error": "è·å–é”€å”®å‘˜ä¿¡æ¯å¤±è´¥",
		})
	}

	// è¿”å›ç»“æœ
	return c.JSON(fiber.Map{
		"data": fiber.Map{
			"stats": stats,
			"salesperson": fiber.Map{
				"id":               salesperson.ID,
				"name":             salesperson.Name,
				"total_sales":      salesperson.TotalSales,
				"total_commission": salesperson.TotalCommission,
			},
		},
	})
}

// GetSalespersonOwnProducts è·å–é”€å”®å‘˜è‡ªå·±å¯é”€å”®çš„äº§å“
func GetSalespersonOwnProducts(c *fiber.Ctx) error {
	// ä»ä¸Šä¸‹æ–‡ä¸­è·å–é”€å”®å‘˜ID
	salespersonID, ok := c.Locals("salesperson_id").(uint)
	if !ok {
		log.Printf("æœªæ‰¾åˆ°é”€å”®å‘˜èº«ä»½ä¿¡æ¯: %v", c.Locals("salesperson_id"))
		return c.Status(fiber.StatusUnauthorized).JSON(fiber.Map{
			"error": "æœªæ‰¾åˆ°é”€å”®å‘˜èº«ä»½ä¿¡æ¯",
		})
	}

	// è®¾ç½®X-Salesperson-Idå¤´ï¼Œç”¨äºè°ƒè¯•
	c.Set("X-Salesperson-Id", fmt.Sprintf("%d", salespersonID))

	// æŸ¥è¯¢é”€å”®å‘˜å¯é”€å”®çš„äº§å“
	var products []struct {
		ID             uint    `json:"id"`
		SalespersonID  uint    `json:"salesperson_id"`
		SoftwareID     uint    `json:"software_id"`
		SoftwareName   string  `json:"software_name"`
		KeyTypeID      uint    `json:"key_type_id"`
		KeyTypeName    string  `json:"key_type_name"`
		Hours          int     `json:"hours"`
		Price          float64 `json:"price"`
		CommissionRate float64 `json:"commission_rate"`
		KeyGenLimit    int     `json:"key_gen_limit"`
		KeysGenerated  int     `json:"keys_generated"`
		IsActive       bool    `json:"is_active"`
	}

	// ä½¿ç”¨JOINæŸ¥è¯¢è·å–å®Œæ•´çš„äº§å“ä¿¡æ?	query := `
		SELECT 
			sp.id, 
			sp.salesperson_id, 
			sp.software_id, 
			s.name AS software_name, 
			sp.key_type_id, 
			kt.name AS key_type_name, 
			kt.hours, 
			kt.price, 
			sp.commission_rate, 
			sp.key_gen_limit, 
			sp.keys_generated, 
			sp.is_active
		FROM 
			salesperson_products sp
		JOIN 
			softwares s ON sp.software_id = s.id
		JOIN 
			key_types kt ON sp.key_type_id = kt.id
		WHERE 
			sp.salesperson_id = ? AND sp.is_active = true AND s.is_active = true AND kt.is_active = true
		ORDER BY 
			s.name, kt.name
	`

	if err := database.GetDB().Raw(query, salespersonID).Scan(&products).Error; err != nil {
		log.Printf("æŸ¥è¯¢é”€å”®å‘˜äº§å“å¤±è´¥: %v", err)
		return c.Status(fiber.StatusInternalServerError).JSON(fiber.Map{
			"error": "æŸ¥è¯¢äº§å“å¤±è´¥",
		})
	}

	// å¦‚æœæ²¡æœ‰æ‰¾åˆ°äº§å“ï¼Œè¿”å›ç©ºæ•°ç»„è€Œä¸æ˜¯é”™è¯?	if len(products) == 0 {
		return c.JSON(fiber.Map{
			"data": []struct{}{},
		})
	}

	// è¿”å›äº§å“åˆ—è¡¨
	return c.JSON(fiber.Map{
		"data": products,
	})
}

// GetSalespersonOwnSales è·å–é”€å”®å‘˜è‡ªå·±çš„é”€å”®è®°å½?func GetSalespersonOwnSales(c *fiber.Ctx) error {
	// ä»ä¸Šä¸‹æ–‡ä¸­è·å–é”€å”®å‘˜ID
	salespersonID, ok := c.Locals("salesperson_id").(uint)
	if !ok {
		return c.Status(fiber.StatusUnauthorized).JSON(fiber.Map{
			"error": "æœªæ‰¾åˆ°é”€å”®å‘˜èº«ä»½ä¿¡æ¯",
		})
	}

	// è§£ææŸ¥è¯¢å‚æ•°
	var query struct {
		Status    string `query:"status"`
		StartDate string `query:"start_date"`
		EndDate   string `query:"end_date"`
		Page      int    `query:"page"`
		PageSize  int    `query:"page_size"`
	}

	if err := c.QueryParser(&query); err != nil {
		return c.Status(fiber.StatusBadRequest).JSON(fiber.Map{
			"error": "æŸ¥è¯¢å‚æ•°è§£æå¤±è´¥",
		})
	}

	// è®¾ç½®é»˜è®¤åˆ†é¡µå‚æ•°
	if query.Page <= 0 {
		query.Page = 1
	}
	if query.PageSize <= 0 {
		query.PageSize = 10
	}

	// æ„å»ºæŸ¥è¯¢æ¡ä»¶
	db := database.GetDB().Model(&models.SalespersonSale{}).Where("salesperson_id = ?", salespersonID)

	// æŒ‰çŠ¶æ€ç­›é€?	if query.Status != "" {
		db = db.Where("status = ?", query.Status)
	}

	// æŒ‰æ—¶é—´èŒƒå›´ç­›é€?	if query.StartDate != "" {
		db = db.Where("created_at >= ?", query.StartDate)
	}
	if query.EndDate != "" {
		db = db.Where("created_at <= ?", query.EndDate)
	}

	// è®¡ç®—æ€»è®°å½•æ•°
	var total int64
	if err := db.Count(&total).Error; err != nil {
		log.Printf("è®¡ç®—é”€å”®è®°å½•æ€»æ•°å¤±è´¥: %v", err)
		return c.Status(fiber.StatusInternalServerError).JSON(fiber.Map{
			"error": "æŸ¥è¯¢é”€å”®è®°å½•å¤±è´?,
		})
	}

	// æŸ¥è¯¢é”€å”®è®°å½?	var sales []models.SalespersonSale
	offset := (query.Page - 1) * query.PageSize
	if err := db.Order("created_at DESC").Offset(offset).Limit(query.PageSize).Find(&sales).Error; err != nil {
		log.Printf("æŸ¥è¯¢é”€å”®è®°å½•å¤±è´? %v", err)
		return c.Status(fiber.StatusInternalServerError).JSON(fiber.Map{
			"error": "æŸ¥è¯¢é”€å”®è®°å½•å¤±è´?,
		})
	}

	// è¿”å›é”€å”®è®°å½?	return c.JSON(fiber.Map{
		"data": fiber.Map{
			"list":      sales,
			"total":     total,
			"page":      query.Page,
			"page_size": query.PageSize,
			"pages":     int(math.Ceil(float64(total) / float64(query.PageSize))),
		},
	})
}

// GetSalespersonOwnCommission è·å–é”€å”®å‘˜è‡ªå·±çš„ä½£é‡‘ç»Ÿè®?func GetSalespersonOwnCommission(c *fiber.Ctx) error {
	// ä»ä¸Šä¸‹æ–‡ä¸­è·å–é”€å”®å‘˜ID
	salespersonID, ok := c.Locals("salesperson_id").(uint)
	if !ok {
		return c.Status(fiber.StatusUnauthorized).JSON(fiber.Map{
			"error": "æœªæ‰¾åˆ°é”€å”®å‘˜èº«ä»½ä¿¡æ¯",
		})
	}

	// æŸ¥è¯¢é”€å”®å‘˜ä¿¡æ¯
	var salesperson models.Salesperson
	if err := database.GetDB().Where("id = ?", salespersonID).First(&salesperson).Error; err != nil {
		log.Printf("æŸ¥è¯¢é”€å”®å‘˜å¤±è´¥: %v", err)
		return c.Status(fiber.StatusInternalServerError).JSON(fiber.Map{
			"error": "æŸ¥è¯¢é”€å”®å‘˜ä¿¡æ¯å¤±è´¥",
		})
	}

	// æŸ¥è¯¢ä½£é‡‘ç»Ÿè®¡
	type CommissionStats struct {
		TotalSales      float64 `json:"total_sales"`
		TotalCommission float64 `json:"total_commission"`
		PendingAmount   float64 `json:"pending_amount"`
		SettledAmount   float64 `json:"settled_amount"`
		CancelledAmount float64 `json:"cancelled_amount"`
	}

	var stats CommissionStats

	// è®¾ç½®æ€»é”€å”®é¢å’Œæ€»ä½£é‡?	stats.TotalSales = salesperson.TotalSales
	stats.TotalCommission = salesperson.TotalCommission

	// æŸ¥è¯¢å¾…ç»“ç®—ä½£é‡?	if err := database.GetDB().Model(&models.SalespersonSale{}).
		Where("salesperson_id = ? AND status = ?", salespersonID, "pending").
		Select("COALESCE(SUM(commission), 0) as pending_amount").
		Scan(&stats.PendingAmount).Error; err != nil {
		log.Printf("æŸ¥è¯¢å¾…ç»“ç®—ä½£é‡‘å¤±è´? %v", err)
	}

	// æŸ¥è¯¢å·²ç»“ç®—ä½£é‡?	if err := database.GetDB().Model(&models.SalespersonSale{}).
		Where("salesperson_id = ? AND status = ?", salespersonID, "settled").
		Select("COALESCE(SUM(commission), 0) as settled_amount").
		Scan(&stats.SettledAmount).Error; err != nil {
		log.Printf("æŸ¥è¯¢å·²ç»“ç®—ä½£é‡‘å¤±è´? %v", err)
	}

	// æŸ¥è¯¢å·²å–æ¶ˆä½£é‡?	if err := database.GetDB().Model(&models.SalespersonSale{}).
		Where("salesperson_id = ? AND status = ?", salespersonID, "cancelled").
		Select("COALESCE(SUM(commission), 0) as cancelled_amount").
		Scan(&stats.CancelledAmount).Error; err != nil {
		log.Printf("æŸ¥è¯¢å·²å–æ¶ˆä½£é‡‘å¤±è´? %v", err)
	}

	// è¿”å›ä½£é‡‘ç»Ÿè®¡
	return c.JSON(fiber.Map{
		"data": stats,
	})
}
